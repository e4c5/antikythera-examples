# Query Optimization Review Prompt

This prompt is designed to be used with AI coding agents (like Antigravity, GitHub Copilot, or VS Code Roo Code) to review the changes generated by the `QueryOptimizer` tool.

---

## ðŸš€ AI Review Prompt
Carry out a review of the diff of the current, focusing on the optimizations made by the `QueryOptimizer` tool.

**Context:**
I have executed an automated `QueryOptimizer` on my Spring Boot / JPA project. The tool has performed two optimizations:
1. **Query Restructuring:** Reordering `WHERE` clause columns in `@Query` annotations based on column cardinality (moving high-cardinality filters to the front).
2. **Schema Enhancement:** Appending new Liquibase `<createIndex>` changesets to the changelog file.
3. **Columns that are identified as low cardinality include: `tenant_id`, `tenant`, `hospital_id`, `hospital`, `is_active`, `active`, `is_deleted`, `deleted`, `group_id`, `group`.**
4. **Additionally, any column that is a boolean or enum type, or follows boolean naming conventions (e.g., `is_`, `has_`, `can_`), is considered low cardinality.**

**Your Objective:**
Conduct a technical review of the current Git diff. Focus on code integrity and call-site synchronization.

**1. Liquibase Validation (IMPORTANT):**
- Do **not** manually review the syntax of the added Liquibase changesets.
- **Instead, call the `validate_liquibase` tool** from the connected MCP server for every modified Liquibase XML file. 
- Only report an issue if the tool identifies a syntax error or a structural problem.

**2. Query & Method Audit:**
- **Validate that every change query is syntactically correct and logically identical to the original, aside from the reordering of conditions.**
- **Logical Reordering:** Verify that the reordered `WHERE` clause in the `@Query` annotation correctly prioritizes columns with higher cardinality.
- **Method Naming:** Ensure the repository method name (e.g., `findByEmailAndStatus`) has been updated to reflect the new order (e.g., `findByStatusAndEmail`) if the optimizer changed the signature.
- **Signature Propagation:** Confirm that for every repository method signature change, all call sites (Services, Controllers, and Tests) have been updated with the correctly ordered arguments. Pay special attention to method references (e.g., `repo::methodName`) and calls involving `this` (e.g., `this.repo.methodName`).

**3. Code Integrity:**
- **Syntax Check:** Verify that the restructuring did not break HQL or SQL syntax. Pay close attention to `AND` placement and whitespace.
- **Java Syntax:** Ensure `TextBlock` (`"""`) usage is correct and that the Lexical Preservation didn't introduce unexpected formatting artifacts.

**4. Index additions:**
- ** If the liquibase file is correctly validated, check each new index that is added to ensure it is valid and will lead to a performance boost. Add comment in the review of each index

**5. Index drops:**
- ** If the liquibase file is correctly validated, identify what indexes are dropped in the liquibase file and make a comment on why it might have been dropped

**6. Method Changes Beyond Reordering:**
- **Scope Validation:** Verify the optimizer ONLY reordered WHERE clause conditions. Flag any other changes to method logic, return types, or filtering behavior.
- **New Methods:** Identify any new repository methods added and ensure they follow the same cardinality-first principle.
- **Query Structure:** Confirm no JOIN conditions, GROUP BY clauses, or ORDER BY clauses were inadvertently modified.
- **Null Handling:** Check if nullable columns in the WHERE clause are properly handledâ€”reordering might affect null behavior in some SQL dialects.

**7. Call-Site Completeness:**
- **Search Strategy:** Use repository-wide grep/search to find ALL usages of changed method names (beyond Services, Controllers, and Tests):
    - Configuration classes
    - Aspect classes
    - Event listeners
    - Batch jobs
    - Dynamic method invocations or reflection-based calls
- **Method References:** Explicitly check for `::` references (e.g., `repository::findByStatusAndEmail`) in streams or functional interfaces.
- **This Context:** Search for `this.` method calls within the repository itself (inherited methods, etc.)
- 
**Output:**
Provide a summary of "Verified Optimizations" and a list of "Regressions/Corrections" if any mismatched signatures or syntax errors are detected.
Place this out in a markdown file that is named as `review-<date>.md`, where `<date>` is the current date in `YYYYMMDD` format. Additionally include
the list of indexes created or dropped and the reasons for each.